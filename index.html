<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ChatVN Online</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="
    https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css
    " rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rowdies:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: "Rowdies", sans-serif;
            font-weight: 300;
            font-style: normal;
        }

        #c {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .c:hover>.ic {
            display: flex !important;
        }

        .ic {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .icacr {
            position: absolute;
            bottom: -5px;
            right: 0;
        }

        .icacl {
            position: absolute;
            bottom: -5px;
            left: 0;
        }

        .bg-m {
            background: rgb(255, 7, 144);
        }

        .border-m {
            border: 1px solid rgb(255, 7, 144);
        }

        .bg-m-800 {
            background: rgb(255, 81, 177);

        }

        .bg-m-600 {
            background: rgb(255, 118, 193);
        }

        .text-m {
            color: rgb(255, 7, 144);
        }
    </style>
</head>

<body>
    <div id="c" class="d-flex flex-column">
        <div id="h" class="w-100 d-flex p-2 flex-row gap-2 align-items-center">
            <h2 class="text-white bg-m text-center text-nowrap text-truncate flex-fill m-0 py-1 px-2 rounded shadow">
                ChatVN
                <span class="text-white bg-m text-nowrap text-truncate un m-0 rounded shadow px-2"> NoName
                </span>

            </h2>
            <svg class="leave text-m d-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                <path fill-rule="evenodd"
                    d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
            </svg>
        </div>
        <div id="load" class="flex-fill d-flex flex-column justify-content-center align-items-center px-2">
            <div class="px-4 py-5 rounded shadow border d-flex flex-column justify-content-center align-items-center">
                <h2 class="text-m text-center text-nowrap m-0 mb-1 px-2 rounded">
                    WelCome To ChatVN</h2>
                <input type="text" class="ip p-3 border-danger  form-control text-center text-m"
                    placeholder="Nhập tên của bạn">
                <div class="d-flex flex-row gap-2 py-1 w-100">
                    <div data-gender="1" class="p-3 cb border-m border-3 text-m text-center flex-fill rounded  ">Nam
                    </div>
                    <div data-gender="2"
                        class="p-3 cb border border-dark bg-white text-dark text-center flex-fill rounded   ">Nữ
                    </div>
                </div>
                <div class=" w-100 d-flex flex-row gap-1">
                    <span class="text-center p-2 flex-fill rounded text-white bg-m-800 w-100 fs-1 btsm">Ghép đôi</span>
                    <span class="text-center p-2 rounded text-white bg-secondary fs-1 btsmc d-none">
                        Hủy
                    </span>
                </div>

                <div class="mt-4">
                    Đang online: <span class="uo">0</span>
                </div>
            </div>
        </div>
        <div id="m" class="d-none flex-fill p-2 d-flex flex-column-reverse overflow-auto">

        </div>
        <div id="f" class="d-none p-2">
            <span class="text-secondary ws"> </span>
            <div class="d-flex shadow p-1 bg-m rounded flex-row align-items-center gap-1">
                <textarea id="fdt" rows="1" class="form-control"></textarea>
                <button id="bsm" class="text-m btn btn-light ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-send-fill" viewBox="0 0 16 16">
                        <path
                            d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://adpixel.jimdev.id.vn/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.6.1/dist/echo.iife.js"></script>
    <script>

        const user = { gender: 1, name: "" };
        let isOk = false;
        let uFr;
        let idFr;
        window.users;
        user.uid = generateRandomUID(0, 99999999);
        window.Echo = new Echo({
            broadcaster: "socket.io",
            host: `https://adpixel.jimdev.id.vn`,
            withCredentials: true,
            auth: {
                headers: {
                    Authorization: user.uid, // Thay YOUR_ACCESS_TOKEN bằng access token của người dùng đã được xác thực
                },
            },
        });
        let echo = window.Echo.join("chat")
            .here((users) => {
                window.users = users;
                getUserOnline()
            })
            .joining((uj) => {
                window.users.push(uj)
                getUserOnline()
            })
            .leaving((ul) => {
                if (ul.id == idFr) {
                    uFr = null;
                    idFr = null;
                    $('.ws').html("Đối phương đã ngắt kết nối !");
                }
                window.users = window.users.filter(u => u.id != ul.id);
                getUserOnline()
            });
        $('.ip').on('input', function () {
            user.name = $(this).val();
            if (user.name.trim() == "") {
                $(this).removeClass("border-m border-3")
                $(this).addClass("border-danger border-1")
            }
            else {
                $(this).removeClass("border-danger border-1")
                $(this).addClass("border-m border-3")
            }
            $('.un').html(user.name);
        })
        $('.cb').on('click', function () {
            $('.cb').removeClass('border-n border-3 text-m')
            $('.cb').addClass('border border-dark text-dark')
            $(this).removeClass('border border-dark text-dark')
            $(this).addClass('border-m border-3 text-m')
            user.gender = $(this).data('gender');
        })

        function getUserOnline() {
            $(".uo").html(window.users.length)
        }
        function generateRandomUID(min, max) {
            const randomNum = Math.floor(Math.random() * (max - min + 1)) + min + Math.floor(Math.random() * (max - min + 700)) + min + Math.floor(Math.floor(Math.random()) + Math.floor(Math.random()));
            return randomNum.toString();
        }

        $('.btsm').on('click', function () {
            if (user.name.trim() == "") {
                toastr.warning("Bạn chưa nhập tên");
                return;
            }
            $('.btsmc').removeClass("d-none");

            $('.btsm').html(`Đang ghép <img style="width: 50px;" src="https://www.phuriengrubber.vn/images/loading2.gif" alt="https://www.phuriengrubber.vn/images/loading2.gif">`)
            user.isFind = true;
            user.isProcess = false;

            userConnect();
        })
        $('.btsmc').on('click', function () {
            $('.btsmc').addClass("d-none");
            $('.btsm').html("Ghép đôi")
            user.isFind = false;
            user.isProcess = false;
        })
        function userConnect() {
            $('.ws').html("");
            function createRoomChat(uID) {
                $('.leave').removeClass("d-none");
                idFr = uID;
                dataChat = [];
                $("#load").addClass("d-none");
                $("#m").removeClass("d-none");
                $("#f").removeClass("d-none");
                $('#fdt').on('input', function () {
                    echo.whisper("ws-" + user.uid, { name: user.name })
                });

                let cn2 = echo.listenForWhisper("chat-" + uID, (event) => {
                    if (event.chat.isEmoji == true) {
                        dataChat[event.chat.index].emoji = event.chat.src;
                        $('.icacr-' + event.chat.index).attr("src", event.chat.src);
                        return;
                    } else {
                        const audio = document.createElement("video");
                        audio.src = "./notification.mp3";
                        audio.play();
                        dataChat.push(event.chat)
                        renderChat(event.chat)
                    }
                }).listenForWhisper("ws-" + uID, (event) => {
                    $('.ws').html(event.name + " đang nhập ...");
                    setTimeout(() => {
                        $('.ws').html("")
                    }, 1000);
                }).listenForWhisper("leave-" + uID, (event) => {
                    uFr = null;
                    idFr = null;
                    $('.ws').html("Đối phương đã ngắt kết nối !");
                })
                $('.leave').on('click', function () {
                    location.reload();
                })
                function renderChat(chat) {
                    let html = '';

                    if (chat.id == user.uid) {
                        html += `
                            <div class="r d-flex flex-row gap-2 py-2 position-relative">
                                <div  class="c ms-auto flex-fill text-wrap">
                                    <div style="background: rgb(255, 81, 177);" class="cm text-wrap shadow pb-0 p-2 rounded text-white">
                                        ${chat.text}
                                        <p class="text-secondary text-center mb-1">${chat.time}</p>
                                    </div>
                                    
                                    <img class="icacl icacr-${chat.index}" style="max-width: 30px; max-height: 30px" src="${chat.emoji}" alt="${chat.emoji}">
                                    <!-- <div data-id="${chat.index}" class="ic p-2 rounded-pill sahdow bg-white">
                                        <img data-id="${chat.index}" class="emoil" style="width: 40px; height: 40px"
                                            src="https://media.tenor.com/_e4JAx0iHS0AAAAj/facebook-emoji.gif"
                                            alt="https://media.tenor.com/_e4JAx0iHS0AAAAj/facebook-emoji.gif">
                                        <img data-id="${chat.index}" class="emoil" style="width: 40px; height: 40px"
                                            src="https://media1.giphy.com/media/hVlZnRT6QW1DeYj6We/giphy.gif?cid=ecf05e47re4b6mnythfjfac2vas4ng420r9pjwkxqfruxiy7&ep=v1_gifs_related&rid=giphy.gif&ct=e"
                                            alt="https://media1.giphy.com/media/hVlZnRT6QW1DeYj6We/giphy.gif?cid=ecf05e47re4b6mnythfjfac2vas4ng420r9pjwkxqfruxiy7&ep=v1_gifs_related&rid=giphy.gif&ct=e">
                                        <img data-id="${chat.index}" class="emoil" style="width: 40px; height: 40px"
                                            src="https://media1.giphy.com/media/nuoSzPYhqz3qCbSMMq/giphy.gif?cid=6c09b9526mi30nbhbes1zjc87o2g0oj2qve6oaq5ksyhrek4&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s"
                                            alt="https://media1.giphy.com/media/nuoSzPYhqz3qCbSMMq/giphy.gif?cid=6c09b9526mi30nbhbes1zjc87o2g0oj2qve6oaq5ksyhrek4&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s">
                                    </div> -->
                                    
                                </div>
                                 
                                 

                            </div>
                            `
                    } else {
                        html += `
                             <div class="l d-flex flex-row gap-2 py-2 position-relative">
                                <img style="width : 20px;height : 20px" class="rounded-circle mt-2"
                                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTlzOvBOBqc0SO0l2JE0Nd9wLbYlWehloZ4TA&s"
                                    alt="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTlzOvBOBqc0SO0l2JE0Nd9wLbYlWehloZ4TA&s">
                                <div class="c flex-fill ">
                                  
                                    <b>${chat.name}</b> 
                                    <div style="background: rgb(255, 118, 193);" class="cm shadow pb-0 p-2 rounded text-white">
                                         ${chat.text}
                                         <p class="text-secondary text-center mb-1">${chat.time}</p>
                                    </div>
                                    <img class="icacr icacr-${chat.index}" style="max-width: 30px; max-height: 30px"
                                        src="${chat.emoji}"
                                        alt="${chat.emoji}">
                                    <div data-id="${chat.index}" class="ic p-2   flex-row rounded-pill sahdow bg-white">
                                        <img data-id="${chat.index}" class="emoil"  style="width: 40px; height: 40px"
                                            src="https://media.tenor.com/_e4JAx0iHS0AAAAj/facebook-emoji.gif"
                                            alt="https://media.tenor.com/_e4JAx0iHS0AAAAj/facebook-emoji.gif">
                                        <img data-id="${chat.index}" class="emoil" style="width: 40px; height: 40px"
                                            src="https://media1.giphy.com/media/hVlZnRT6QW1DeYj6We/giphy.gif?cid=ecf05e47re4b6mnythfjfac2vas4ng420r9pjwkxqfruxiy7&ep=v1_gifs_related&rid=giphy.gif&ct=e"
                                            alt="https://media1.giphy.com/media/hVlZnRT6QW1DeYj6We/giphy.gif?cid=ecf05e47re4b6mnythfjfac2vas4ng420r9pjwkxqfruxiy7&ep=v1_gifs_related&rid=giphy.gif&ct=e">
                                        <img data-id="${chat.index}" class="emoil" style="width: 40px; height: 40px"
                                            src="https://media1.giphy.com/media/nuoSzPYhqz3qCbSMMq/giphy.gif?cid=6c09b9526mi30nbhbes1zjc87o2g0oj2qve6oaq5ksyhrek4&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s"
                                            alt="https://media1.giphy.com/media/nuoSzPYhqz3qCbSMMq/giphy.gif?cid=6c09b9526mi30nbhbes1zjc87o2g0oj2qve6oaq5ksyhrek4&ep=v1_internal_gif_by_id&rid=giphy.gif&ct=s">
                                              <img data-id="${chat.index}" class="emoil" style="width: 40px; height: 40px"
                                            src="https://media.tenor.com/RYibGej0GvcAAAAi/facebook-emoji.gif"
                                            alt="https://media.tenor.com/RYibGej0GvcAAAAi/facebook-emoji.gif">
                                    </div>
                                </div>
                                <svg data-id="${chat.index}" class="reply my-auto" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-reply" viewBox="0 0 16 16">
                                    <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.7 8.7 0 0 0-1.921-.306 7 7 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254l-.042-.028a.147.147 0 0 1 0-.252l.042-.028zM7.8 10.386q.103 0 .223.006c.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96z"/>
                                </svg>
                            </div>
                        `
                    }
                    $('#m').prepend(html);
                }
                $(document).on('click', '.reply', function () {
                    $('.ic').hide();
                    let index = $(this).data("id");
                })
                $(document).on('click', '.emoil', function () {
                    $('.ic').hide();
                    let index = $(this).data("id");
                    let src = $(this).attr("src");
                    dataChat[index].emoji = src;
                    $('.icacr-' + index).attr("src", src);
                    echo.whisper("chat-" + user.uid, {
                        chat: {
                            index: index,
                            src: src,
                            isEmoji: true
                        }
                    })
                })
                $("#bsm").on('click', function () {
                    let val = $('#fdt').val().replace(/\n/g, "<br />");
                    $('#fdt').val("");
                    if (val.trim("") != "") {
                        const now = new Date();
                        const day = now.getDate();
                        const month = now.getMonth() + 1;
                        const year = now.getFullYear();
                        const hours = now.getHours();
                        const minutes = now.getMinutes();
                        const seconds = now.getSeconds();
                        const time = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                        dataChat.push({
                            id: user.uid,
                            name: user.name,
                            text: val,
                            emoji: "",
                            index: dataChat.length - 1,
                            time: time
                        })
                        renderChat({
                            id: user.uid,
                            name: user.name,
                            text: val,
                            emoji: "",
                            index: dataChat.length - 1,
                            time: time
                        });
                        echo.whisper("chat-" + user.uid, {
                            chat: {
                                id: user.uid,
                                name: user.name,
                                text: val,
                                emoji: "",
                                index: dataChat.length - 1,
                                time: time
                            }
                        })
                    }
                })
            }

            echo.listenForWhisper("connect-user-" + user.uid + user.gender, async (event) => {
                if (uFr) return;
                if (idFr && idFr != event.userId) {
                    idFr = null;
                    return;
                }
                console.log(event)
                idFr = event.userId;
                if (user.isFind && !user.isChat) {
                    user.isProcess = true;
                    if (event.isOk == true && isOk == true && user.isFind && user.isProcess) {
                        uFr = event;
                        createRoomChat(event.userId);
                        echo.whisper("connect-user-" + event.userId + event.gender, {
                            userId: user.uid,
                            gender: user.gender,
                            name: user.name,
                            isOk: isOk
                        });
                        user.isFind = false;
                        user.isProcess = false;
                    } else {
                        isOk = true;
                        echo.whisper("connect-user-" + event.userId + event.gender, {
                            userId: user.uid,
                            gender: user.gender,
                            name: user.name,
                            isOk: isOk
                        })
                    }
                }
            });
            for (let u of window.users) {
                if (u.gender !== user.gender)
                    echo.whisper("connect-user-" + u.id + (user.gender == 1 ? 2 : 1), {
                        userId: user.uid,
                        gender: user.gender,
                        name: user.name
                    })
            }
        }
    </script>
</body>

</html>